---
title: "Model Comparison"
author: "Manikya Aluster"
date: "2023-08-28"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
rm(list=ls())
lib = .libPaths("~/Library/Frameworks/R.framework/Versions/4.1/Resources/library")
library(here, lib.loc = lib)
library(modelProb)
library(xtable)

n = 7
v_models <- c(#"simple", 
              "v-linear",
              #"v-power",
              "v-exp",
              #"v-delayed-pow",
              "v-delayed-exp",
              "v-blocked-simple",
              #"v-blocked-complex",  # only including complex blocked models as a sanity check, not in model compariso
              #"v-blocked-exp-ul",
              "v-delayed-exp-blocked",
                "v-blocked-exp-sb"

              )

a_models <- c("simple",
              "a-linear",
              #"a-power",
              "a-exp",
              #"a-delayed-power",
              "a-delayed-exp",
              "a-blocked-simple",
              "a-delayed-exp-blocked",

              #"a-blocked-complex", # only including complex blocked models as a sanity check, not in model comparisons
              "a-blocked-exp-sb",
              #"a-blocked-exp-ul",
              "a-step")

models_2p = c(
  "v-a-exp",
  "v-a-linear",
  "v-linear-a-exp",
  "v-linear-a-blocked-simple",
  "v-exp-a-dExp-blocked"

)


models <- c(a_models, v_models, models_2p)

full_names <- c("Standard DDM", "a Linear", "a Exponential", "a Delayed Exp", "a Constant Block", "a Delayed Exp Block", "a Exp Trial + Constant Block", "a Step", "v Linear", "v Exponential", "v Delayed Exponential", "v Constant Block", "v Delayed Exp Block", "v Exp Trial + Constant Block", "a + v Exponential", "a + v Linear", "a Exp + v Linear", "a Constant Block + v Linear", "a Delayed Exp Blocked + v Exp")

```

```{r}
IC_array <- function(models, criterion) {
  # set up empty array
  allIC <- as.data.frame(matrix(ncol = length(models)))
  colnames(allIC) <- c(models)
  
  for (model in models) {
    for (i in 1:n) {
      load(here(
        paste(
          "data/evansetal-17/derived/normal/P",
          i,
          "_",
          model,
          "-IC.Rdata",
          sep = ""
        )
      ))
      if (criterion == "AIC") {
        IC <- AIC
      } else if (criterion == "BIC") {
        IC <- BIC
      }
      allIC[i, model] <- IC
    }
  }
  allIC
}

rank_models <- function(scores_array) {
  # apply the ranking function to each row of the array
  ranked_array <- t(apply(scores_array, 1, rank))
  
  # create a new array to store the model names
  model_names <-
    array(dim = dim(ranked_array),
          dimnames = dimnames(ranked_array))
  
  # loop over each row of the ranked array
  for (i in 1:nrow(ranked_array)) {
    # sort the row by the rank and get the corresponding column names
    model_names[i,] <-
      colnames(ranked_array)[order(ranked_array[i,])]
  }
  
  colnames(model_names) <- 1:length(scores_array[1,])
  return(model_names)
}

# make a function that gets the weightet IC from a vector models
weighted_IC_from_models <- function(models, IC_array) {
  # set up empty vector to fill with IC values
  ICs <- c()
  for (i in 1:length(IC_array[, 1])) {
    ICs[i] <- IC_array[i, models[i]]
  }
  ICs
}

# get a vector of just the single parameter models
models_1p <- models[!(models %in% models_2p)]

# make a function that returns the best IC for a given set of models and IC
best_IC_from_models = function(models, ICs = c("AIC", "BIC")) {
  # set up empty array to fill with best models and their ICs
  best_IC <- as.data.frame(matrix(ncol = length(ICs) * 2, nrow = n))
  colnames(best_IC) <- c(ICs, paste0("best_model_", ICs))
  
  for (IC in ICs) {
    IC_array_name <- paste0("all", IC)
    # turn string into object
    IC_array <- get(IC_array_name)
    IC_array <- IC_array[, models]
    # get column name for best model loop iteration
    best_model_colname <- paste0("best_model_", IC)
    #get the best model for each participant according to the IC
    best_models <- rank_models(IC_array)
    # add rthhe model names to the data frame
    best_IC[, best_model_colname] <- best_models[, 1]
    # get the actual  IC for the best model
    best_IC[, IC] <- weighted_IC_from_models(best_models, IC_array)
  }
  best_IC
}

```

```{r}
allAIC <- IC_array(models, "AIC")
allBIC <- IC_array(models, "BIC")
save(allAIC, file = here("data/evansetal-17/derived/normal/allAIC.Rdata"))
save(allBIC, file = here("data/evansetal-17/derived/normal/allBIC.Rdata"))

colnames(allAIC) <- full_names
colnames(allBIC) <- full_names

```

```{r}
# get IC weights
BIC_weights <- modelProb::weightedICs(allBIC)
AIC_weights <- modelProb::weightedICs(allAIC)

getNBest = function(allIC){
  n_IC = table(full_names[apply(allIC, 1, which.min)])
n = rep(0, length(full_names))
names(n) = full_names
n[names(n_IC)] <- n_IC
n
}
n_best <- getNBest(allBIC)
group_level_probs <- round(apply(BIC_weights, 2, mean), 3)
group_level_probs[group_level_probs == 0] <- "< .001"

combined <- cbind(full_names, unname(n_best), unname(group_level_probs))
colnames(combined) <- c("Models", "n Best Fit", "Probability")

# Apply regex substitution to convert "<" to "$<" in the third column
combined[, 3] <- gsub("<", "$<$", combined[, 3])

# Apply regex substitution to convert "0.03" to ".03" in the third column
combined[, 3] <- gsub("\\b0\\.", ".", combined[, 3])

# Apply regex substitution to convert "a" and "v" to "$a$" $v$ in the third column

combined[, 1] <- gsub("(^|\\s)([av])($|\\s)", "\\1$\\2$\\3", combined[, 1])

# print as latex table

# Create a LaTeX table conforming to APA formatting standards
latex_table <- xtable(combined, caption = "Table Caption Here", label = "tab:table_label")

# Print the LaTeX table
print(latex_table, include.rownames = TRUE, sanitize.text.function = function(x) x)

```

```{r}
# Rank the best models for each participant
rankBIC <- rank_models(allBIC)
rankAIC <- rank_models(allAIC)

# Get the best model for each participant
best_BIC <- rankBIC[, 1]
save(best_BIC, file = here("data/evansetal-17/derived/normal/best_BIC"))
best_AIC <- rankAIC[, 1]
save(best_AIC, file = here("data/evansetal-17/derived/normal/best_AIC"))
```

## Best change model versus the simple model for each participant

```{r}
# Best model versus simple model

# get IC for models
simple_AIC <- allAIC[,"simple"]
simple_BIC <- allBIC[,"simple"]
best_no_simple <- best_IC_from_models(models[models!="simple"])

# get weighted IC
weighted_simpleVbest_AIC <- weightedICs(cbind(simple_AIC, best_no_simple$AIC))
colnames(weighted_simpleVbest_AIC) = c("simple", "best alternative")
weighted_simpleVbest_BIC <- weightedICs(cbind(simple_BIC, best_no_simple$BIC))
colnames(weighted_simpleVbest_BIC) = c("simple", "best alternative")

# plot 
plotWeightedICs(weighted_simpleVbest_AIC, main = "AIC")
plotWeightedICs(weighted_simpleVbest_BIC, main = "BIC")


apply(weighted_simpleVbest_AIC,2, mean)
apply(weighted_simpleVbest_BIC,2, mean)



```

## Best single parameter model versus best 2 parameter model for each participant

```{r}
# get the best single parameter models
best_IC_1p <- best_IC_from_models(models_1p)

# get the best 2 parameter models
best_IC_2p <- best_IC_from_models(models_2p)

# plot best 1p v best 2p
n_param_comparison_BIC <-
  cbind(best_IC_1p[, "BIC"], best_IC_2p[, "BIC"])
n_param_comparison_weights_BIC <-
  weightedICs(n_param_comparison_BIC)
colnames(n_param_comparison_weights_BIC) <-
  c("Best 1 parameter model", "Best 2 parameter model")
plotWeightedICs(n_param_comparison_weights_BIC, main = "BIC")

n_param_comparison_AIC <-
  cbind(best_IC_1p[, "AIC"], best_IC_2p[, "AIC"])
n_param_comparison_weights_AIC <-
  weightedICs(n_param_comparison_AIC)
colnames(n_param_comparison_weights_AIC) <-
  c("Best 1 parameter model", "Best 2 parameter models")
plotWeightedICs(n_param_comparison_weights_AIC, main = "AIC")

apply(n_param_comparison_weights_AIC, 2, mean)
apply(n_param_comparison_weights_BIC, 2, mean)

```

## Best a change models v best v change models 


Comparing all models that allow a to vary against those that allow v to vary. 

```{r}
# All models that assume a change versus v change

a_change <- models[grep("a-", models)]
v_change <- models[grep("v-", models)]

# get weighted IC without the two parameter models 
weighted_1p_AIC <- weightedICs(allAIC[c(a_change, v_change)])
weighted_1p_BIC <- weightedICs(allBIC[c(a_change, v_change)])

# plot 
MMComparisonPlot(weighted_1p_AIC, a_change, v_change, groupNames = c("a change models", "v change models"))

```

Comparing only single parameter models that allow a to vary versus single parameter models that allow v to vary (since 2 parameter models allow both and so cancel each other out)

```{r}
# All models that assume a change versus v change -- single parameter models only

# get weighted IC without the two parameter models 
weighted_1p_AIC <- weightedICs(allAIC[c(a_models, v_models)])
weighted_1p_BIC <- weightedICs(allBIC[c(a_models, v_models)])

# plot 
MMComparisonPlot(weighted_1p_AIC, a_models, v_models, groupNames = c("a change models", "v change models"), main = "AIC")
MMComparisonPlot(weighted_1p_BIC, a_models, v_models, groupNames = c("a change models", "v change models"), main = "BIC")
```


Comparing the best a model versus the best v model for each participant. 

```{r}
# best model that assumes a change versus v change 
a_best <- best_IC_from_models(a_models)
v_best <- best_IC_from_models(v_models)

a_v_weighted_AIC <- weightedICs(cbind(a_best$AIC, v_best$AIC))
colnames(a_v_weighted_AIC) <- c("best a model", "best v model")
MMComparisonPlot(a_v_weighted_AIC,"best a model", "best v model", groupNames = colnames(a_v_weighted_AIC), colours = c("orange", "red"), main = "AIC")

a_v_weighted_BIC <- weightedICs(cbind(a_best$BIC, v_best$BIC))
colnames(a_v_weighted_BIC) <- c("best a model", "best v model")
MMComparisonPlot(a_v_weighted_BIC, "best a model", "best v model", groupNames = colnames(a_v_weighted_BIC), colours = c("orange", "red"), main = "BIC")

```
```{r}
count_a_v <- apply(a_v_weighted_BIC, 1, which.max)
count_a_v <- c(a_models = sum(count_a_v == 1), v_models = sum(count_a_v == 2))
barplot(count_a_v)
```


## Block varying models versus trial-only varying models

```{r}
blocked_models <- models[grep("blocked", models)]
trial_models <- models[!models %in% blocked_models] # <--

# because there are more trial models thhan blocked models, more apropriate to compare the best trial/block model for each participant. 

best_blocked <- best_IC_from_models(blocked_models)
best_trial <- best_IC_from_models(trial_models)

groups <- c("Best block change", "Best trial change")
weighted_blockVtrial_AIC <- weightedICs(cbind(best_blocked$AIC, best_trial$AIC))
colnames(weighted_blockVtrial_AIC) <- groups

weighted_blockVtrial_BIC <- weightedICs(cbind(best_blocked$BIC, best_trial$BIC))
colnames(weighted_blockVtrial_BIC) <- groups

plotWeightedICs(weighted_blockVtrial_AIC, main = "AIC")
plotWeightedICs(weighted_blockVtrial_BIC, main = "BIC")


```

How mant participants were best fit by a blocked model versus a trial model
```{r}
count_blockedVtrial <- apply(weighted_blockVtrial_BIC, 1, which.max)
count_blockedVtrial <- c(blocked = sum(count_blockedVtrial == 1), trial = sum(count_blockedVtrial == 2))
count_blockedVtrial
barplot(count_blockedVtrial)


```

